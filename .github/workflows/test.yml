name: Test Matrix
on:
  pull_request:
  push: { branches: [ master ] }
jobs:
  tests-linux:
    strategy:
      matrix:
        runner: ['swift:5.2-xenial', 'swift:5.2-bionic',
                 'swiftlang/swift:nightly-5.2-xenial', 'swiftlang/swift:nightly-5.2-bionic',
                 'swiftlang/swift:nightly-5.3-xenial', 'swiftlang/swift:nightly-5.3-bionic',
                 'swiftlang/swift:nightly-master-xenial', 'swiftlang/swift:nightly-master-bionic',
                 'swiftlang/swift:nightly-master-focal',
                 'swiftlang/swift:nightly-master-centos8', 'swiftlang/swift:nightly-master-amazonlinux2']
        include:
          - installcmd: 'apt-get -q update && apt-get -q install -y curl'
          - { 'runner': 'swiftlang/swift:nightly-master-centos8', 'installcmd': 'true' }
          - { 'runner': 'swiftlang/swift:nightly-master-amazonlinux2', 'installcmd': 'true' }
    container: ${{ matrix.runner }}
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: ${{ matrix.installcmd }}
      - name: Check out code
        uses: actions/checkout@v2
      - name: Run tests with Thread Sanitizer and code coverage
        run: swift test --enable-test-discovery --sanitize=thread
  tests-macos:
    runs-on: macos-latest
    steps:
      - name: Select latest available Xcode
        uses: maxim-lobanov/setup-xcode@1.0
        with: { 'xcode-version': 'latest' }
      - name: Check out code
        uses: actions/checkout@v2
      - name: Run tests with Thread Sanitizer
        run: swift test --enable-test-discovery --sanitize=thread
